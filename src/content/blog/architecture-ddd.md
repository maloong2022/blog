---
author: Maloong🐎🐲
pubDatetime: 2023-05-16T23:32:00Z
title: 卷起来🐎🐲💪 -- DDD
postSlug: architecture-ddd
featured: false
draft: false
tags:
  - Architecture
  - DDD
ogImage: ""
description: 领域驱动设计DDD(Domain-Driven Design)历史较长但随着微服务的兴起DDD又活跃到人们的视线，它提供的是一套架构设计思想，我们可以使用这套方法论将架构设计的尽可能做到高内聚、低耦合、可扩展性强的应用服务。
---
领域驱动设计DDD(Domain-Driven Design)历史较长但随着微服务的兴起DDD又活跃到人们的视线，它提供的是一套架构设计思想，我们可以使用这套方法论将架构设计的尽可能做到高内聚、低耦合、可扩展性强的应用服务。

DDD（Domain-Driven Design 领域驱动设计）是由Eric Evans最先提出，目的是对软件所涉及到的领域进行建模，以应对系统规模过大时引起的软件复杂性的问题。整个过程大概是这样的，开发团队和领域专家一起通过 通用语言(Ubiquitous Language)去理解和消化领域知识，从领域知识中提取和划分为一个一个的子领域（核心子域，通用子域，支撑子域），并在子领域上建立模型，再重复以上步骤，这样周而复始，构建出一套符合当前领域的模型。

![img](https://bugstack.cn/assets/images/pic-content/2019/10/DDD-01-1.png)

## Table of contents

### **开发目标**


依靠领域驱动设计的设计思想，通过事件风暴建立领域模型，合理划分领域逻辑和物理边界，建立领域对象及服务矩阵和服务架构图，定义符合DDD分层架构思想的代码结构模型，保证业务模型与代码模型的一致性。通过上述设计思想、方法和过程，指导团队按照DDD设计思想完成微服务设计和开发。

1. 拒绝泥球小单体、拒绝污染功能与服务、拒绝一加功能排期一个月
2. 架构出高可用极易符合互联网高速迭代的应用服务
3. 物料化、组装化、可编排的服务，提高人效

### **服务架构**

![](https://s2.loli.net/2023/05/16/Oa7XiZbstAzugM2.png)


* 应用层{application}

  * 应用服务位于应用层。用来表述应用和用户行为，负责服务的组合、编排和转发，负责处理业务用例的执行顺序以及结果的拼装。
  * 应用层的服务包括应用服务和领域事件相关服务。
  * 应用服务可对**微服务内的领域服务**以及**微服务外的应用服务**进行组合和编排，或者**对基础层如文件、缓存等数据直接操作形成应用服务，对外提供粗粒度的服务。**
  * 领域事件服务包括两类：领域事件的发布和订阅。通过事件总线和消息队列实现异步数据传输，实现微服务之间的解耦。
* 领域层{domain}

  * 领域服务位于领域层，为完成领域中跨实体或值对象的操作转换而封装的服务，领域服务以与实体和值对象相同的方式参与实施过程。
  * 领域服务对**同一个实体**的一个或多个方法进行组合和封装，或对**多个不同实体的操作进行组合或编排**，对外暴露成领域服务。领域服务封装了核心的业务逻辑。实体自身的行为在实体类内部实现，向上封装成领域服务暴露。
  * 为隐藏领域层的业务逻辑实现，**所有领域方法和服务等均须通过领域服务对外暴露**。
  * 为实现微服务内聚合之间的解耦，**原则上禁止跨聚合的领域服务调用和跨聚合的数据相互关联**。
* 基础层{infrastructrue}

  * 基础服务位于基础层。为各层提供资源服务（如数据库、缓存等），实现各层的解耦，降低外部资源变化对业务逻辑的影响。
  * 基础服务主要为仓储服务，通过依赖反转的方式为各层提供基础资源服务，领域服务和应用服务调用仓储服务接口，利用仓储实现持久化数据对象或直接访问基础资源。
* 接口层{interfaces}

  * 接口服务位于用户接口层，用于处理用户发送的Restful请求和解析用户输入的配置文件等，并将信息传递给应用层。


### 项目实战

#### 需求

本案例通过一个商品下单规则的场景来进行演示DDD；

1. 假设产品需求业务运行人员可以对不同的商品配置一些规则，这些规则可以满足不同用户类型可以下单不同商品。
2. 另外一些行为规则是会随着业务发展而增加或者变动的，所以不能写死｛写死太吓人了｝。
3. 数据库的PO类不应该被外部服务调用，这也是必须的。如果你开发过很多系统，那么可能已经吃过亏并意识到这个问题。
4. 按照DDD思想我们尝试需要设计一个规则引擎的服务，通过给外部提供非常简单的接口（application）来获取最终结果。
5. 通过这样的案例可以很容易的感受到目前的四层架构确实在实现DDD思想上有很多的帮助。

#### 系统架构图

微服务不是泥球小单体，而是具备更加清晰职责边界的完整一体的业务功能服务。领域驱动设计的思想通过Domain的功能域设计，可以把核心功能与支撑功能很好的区分开。而在MVC的设计模式尝尝是把所有的；数据服务、定义的属性类、提供的功能都在一条线上，这样是非常快速的开发方式但在做微服务部署时候确很麻烦。

按照不同的业务场景可能设计出软件在数据库使用上会有单库单表或者分库分表，如果是一个体量足够需要分库分表设计的系统，在扩容时候它是否能满足你的需求包括；

1. 核心计算不涉及库扩容，但是系统功能都在一起怎么办，已扩容都扩容了很浪费
2. 所有的扩容都涉及到数据库连接数增加，但并不是每个行为都直达到所有库表
3. 持续发展的业务会带来数据激增，将来怎么进行扩展，重新洗数据并不是很好的选择
4. 那么实际开发大泥球架构时，不只是会遇到上面的问题，还可能会遇到工期很赶加个人也不提升效率，反复交接代码扶不过三代等等，因此我们将服务拆分为独立单体具备此核心域完整功能的系统是非常必要的。

如图，是微服务数据库使用的一种思想，我们希望路由层从最开始就被执行，用户分群动态扩展

![](https://s2.loli.net/2023/05/17/OSr2V3QjpYmXPaq.png)

本案例通过使用SpringCloud将我们的服务架构扩展为通过路由调用的微服务

1. 首先通过Eureka作为服务注册与发现中心
2. 然后使用Feign模式作为调用API接口
3. 最后依赖于zuul设置路由转发功能

#### 主要服务架构图

![DDD系统架构图](https://s2.loli.net/2023/05/16/Oa7XiZbstAzugM2.png)

#### 业务设计

通过领域驱动设计的思想，从领域知识中提取和划分为一个一个的子领域（核心子域，通用子域，支撑子域），并在子领域上建立模型。那么在技术实现上就需要去支撑这种建模，以使我们的代码模块独立、免污染、易于扩展。

在上面我们提到需要开发一个可扩展使用的规则树，那么如果只是单纯的一次性需求，最快的方式是if语句就搞定了。但是为了使这个领域服务具备良好的使用和扩展性，我们需要做些拆分，那么如下；

1. 你是否想过系统在过滤过则的时候其实就像执行一棵二叉树一样非左即右侧，每一条线上都有着执行条件，通过判断来达到最终的结果。
2. 按照树形结构我们将定义出来四个类；树、节点、果实、指向线(From-To)，用于描述我们的规则行为。
3. 再此基础上需要实现一个逻辑定义与规则树执行引擎，通过统一的引擎服务来执行我们每次配置好的规则树。

![领域开发设计服务](https://s2.loli.net/2023/05/17/7AVym2IDOgwCSsz.png)

#### 代码地址

[springcloud+ddd代码仓库](https://github.com/maloong2022/springcloud-ddd-crash)
