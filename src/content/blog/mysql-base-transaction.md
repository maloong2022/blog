---
author: MaloongðŸŽðŸ²
pubDatetime: 2023-04-13T09:00:00Z
title: å·èµ·æ¥ðŸŽðŸ²ðŸ’ª -- MySQLäº‹ç‰©éš”ç¦»
postSlug: mysql-base-transaction
featured: false
draft: false
tags:
  - MySQL
  - Transaction
ogImage: ""
description: äº‹åŠ¡å°±æ˜¯è¦ä¿è¯ä¸€ç»„æ•°æ®åº“æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚åœ¨ MySQL ä¸­ï¼Œäº‹åŠ¡æ”¯æŒæ˜¯åœ¨å¼•æ“Žå±‚å®žçŽ°çš„ã€‚ä½ çŽ°åœ¨çŸ¥é“ï¼ŒMySQL æ˜¯ä¸€ä¸ªæ”¯æŒå¤šå¼•æ“Žçš„ç³»ç»Ÿï¼Œä½†å¹¶ä¸æ˜¯æ‰€æœ‰çš„å¼•æ“Žéƒ½æ”¯æŒäº‹åŠ¡ã€‚æ¯”å¦‚ MySQL åŽŸç”Ÿçš„ MyISAM å¼•æ“Žå°±ä¸æ”¯æŒäº‹åŠ¡ï¼Œè¿™ä¹Ÿæ˜¯ MyISAM è¢« InnoDB å–ä»£çš„é‡è¦åŽŸå› ä¹‹ä¸€ã€‚
---
1. äº‹åŠ¡çš„æ¦‚å¿µæ˜¯ä»€ä¹ˆ?
2. mysqlçš„äº‹åŠ¡éš”ç¦»çº§åˆ«è¯»æœªæäº¤, è¯»å·²æäº¤, å¯é‡å¤è¯», ä¸²è¡Œå„æ˜¯ä»€ä¹ˆæ„æ€?
3. è¯»å·²æäº¤, å¯é‡å¤è¯»æ˜¯æ€Žä¹ˆé€šè¿‡è§†å›¾æž„å»ºå®žçŽ°çš„?
4. å¯é‡å¤è¯»çš„ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹? å¯¹è´¦çš„æ—¶å€™åº”è¯¥å¾ˆæœ‰ç”¨?
5. äº‹åŠ¡éš”ç¦»æ˜¯æ€Žä¹ˆé€šè¿‡read-view(è¯»è§†å›¾)å®žçŽ°çš„?
6. å¹¶å‘ç‰ˆæœ¬æŽ§åˆ¶(MCVV)çš„æ¦‚å¿µæ˜¯ä»€ä¹ˆ, æ˜¯æ€Žä¹ˆå®žçŽ°çš„?
7. ä½¿ç”¨é•¿äº‹åŠ¡çš„å¼Šç—…? ä¸ºä»€ä¹ˆä½¿ç”¨å¸¸äº‹åŠ¡å¯èƒ½æ‹–åž®æ•´ä¸ªåº“?
8. äº‹åŠ¡çš„å¯åŠ¨æ–¹å¼æœ‰å“ªå‡ ç§?
9. commit work and chainçš„è¯­æ³•æ˜¯åšä»€ä¹ˆç”¨çš„?
10. æ€Žä¹ˆæŸ¥è¯¢å„ä¸ªè¡¨ä¸­çš„é•¿äº‹åŠ¡?
11. å¦‚ä½•é¿å…é•¿äº‹åŠ¡çš„å‡ºçŽ°?

äº‹åŠ¡å°±æ˜¯è¦ä¿è¯ä¸€ç»„æ•°æ®åº“æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚åœ¨ MySQL ä¸­ï¼Œäº‹åŠ¡æ”¯æŒæ˜¯åœ¨å¼•æ“Žå±‚å®žçŽ°çš„ã€‚ä½ çŽ°åœ¨çŸ¥é“ï¼ŒMySQL æ˜¯ä¸€ä¸ªæ”¯æŒå¤šå¼•æ“Žçš„ç³»ç»Ÿï¼Œä½†å¹¶ä¸æ˜¯æ‰€æœ‰çš„å¼•æ“Žéƒ½æ”¯æŒäº‹åŠ¡ã€‚æ¯”å¦‚ MySQL åŽŸç”Ÿçš„ MyISAM å¼•æ“Žå°±ä¸æ”¯æŒäº‹åŠ¡ï¼Œè¿™ä¹Ÿæ˜¯ MyISAM è¢« InnoDB å–ä»£çš„é‡è¦åŽŸå› ä¹‹ä¸€ã€‚ç»å¸¸å¬ DBA åŒäº‹è¯´ï¼ŒMySQL å¯ä»¥æ¢å¤åˆ°åŠä¸ªæœˆå†…ä»»æ„ä¸€ç§’çš„çŠ¶æ€ï¼ŒæƒŠå¹çš„åŒæ—¶ï¼Œä½ æ˜¯ä¸æ˜¯å¿ƒä¸­ä¹Ÿä¼šä¸å…ä¼šå¥½å¥‡ï¼Œè¿™æ˜¯æ€Žæ ·åšåˆ°çš„ã€‚

## Table of contents

## éš”ç¦»æ€§ä¸Žéš”ç¦»çº§åˆ«

æåˆ°äº‹åŠ¡ï¼Œä½ è‚¯å®šä¼šæƒ³åˆ° ACIDï¼ˆAtomicityã€Consistencyã€Isolationã€Durabilityï¼Œå³åŽŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§ã€æŒä¹…æ€§ï¼‰ã€‚

å½“æ•°æ®åº“ä¸Šæœ‰å¤šä¸ªäº‹åŠ¡åŒæ—¶æ‰§è¡Œçš„æ—¶å€™ï¼Œå°±å¯èƒ½å‡ºçŽ°è„è¯»ï¼ˆdirty readï¼‰ã€ä¸å¯é‡å¤è¯»ï¼ˆnon-repeatable readï¼‰ã€å¹»è¯»ï¼ˆphantom readï¼‰çš„é—®é¢˜ï¼Œä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œå°±æœ‰äº†â€œéš”ç¦»çº§åˆ«â€çš„æ¦‚å¿µã€‚

åœ¨è°ˆéš”ç¦»çº§åˆ«ä¹‹å‰ï¼Œä½ é¦–å…ˆè¦çŸ¥é“ï¼Œä½ éš”ç¦»å¾—è¶Šä¸¥å®žï¼Œæ•ˆçŽ‡å°±ä¼šè¶Šä½Žã€‚å› æ­¤å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬éƒ½è¦åœ¨äºŒè€…ä¹‹é—´å¯»æ‰¾ä¸€ä¸ªå¹³è¡¡ç‚¹ã€‚SQL æ ‡å‡†çš„äº‹åŠ¡éš”ç¦»çº§åˆ«åŒ…æ‹¬ï¼šè¯»æœªæäº¤ï¼ˆread uncommittedï¼‰ã€è¯»æäº¤ï¼ˆread committedï¼‰ã€å¯é‡å¤è¯»ï¼ˆrepeatable readï¼‰å’Œä¸²è¡ŒåŒ–ï¼ˆserializable ï¼‰ã€‚

* è¯»æœªæäº¤æ˜¯æŒ‡ï¼Œä¸€ä¸ªäº‹åŠ¡è¿˜æ²¡æäº¤æ—¶ï¼Œå®ƒåšçš„å˜æ›´å°±èƒ½è¢«åˆ«çš„äº‹åŠ¡çœ‹åˆ°ã€‚
* è¯»æäº¤æ˜¯æŒ‡ï¼Œä¸€ä¸ªäº‹åŠ¡æäº¤ä¹‹åŽï¼Œå®ƒåšçš„å˜æ›´æ‰ä¼šè¢«å…¶ä»–äº‹åŠ¡çœ‹åˆ°ã€‚
* å¯é‡å¤è¯»æ˜¯æŒ‡ï¼Œä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çœ‹åˆ°çš„æ•°æ®ï¼Œæ€»æ˜¯è·Ÿè¿™ä¸ªäº‹åŠ¡åœ¨å¯åŠ¨æ—¶çœ‹åˆ°çš„æ•°æ®æ˜¯ä¸€è‡´çš„ã€‚å½“ç„¶åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œæœªæäº¤å˜æ›´å¯¹å…¶ä»–äº‹åŠ¡ä¹Ÿæ˜¯ä¸å¯è§çš„ã€‚
* ä¸²è¡ŒåŒ–ï¼Œé¡¾åæ€ä¹‰æ˜¯å¯¹äºŽåŒä¸€è¡Œè®°å½•ï¼Œâ€œå†™â€ä¼šåŠ â€œå†™é”â€ï¼Œâ€œè¯»â€ä¼šåŠ â€œè¯»é”â€ã€‚å½“å‡ºçŽ°è¯»å†™é”å†²çªçš„æ—¶å€™ï¼ŒåŽè®¿é—®çš„äº‹åŠ¡å¿…é¡»ç­‰å‰ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œå®Œæˆï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚

å…¶ä¸­â€œè¯»æäº¤â€å’Œâ€œå¯é‡å¤è¯»â€æ¯”è¾ƒéš¾ç†è§£ï¼Œæ‰€ä»¥æˆ‘ç”¨ä¸€ä¸ªä¾‹å­è¯´æ˜Žè¿™å‡ ç§éš”ç¦»çº§åˆ«ã€‚å‡è®¾æ•°æ®è¡¨ T ä¸­åªæœ‰ä¸€åˆ—ï¼Œå…¶ä¸­ä¸€è¡Œçš„å€¼ä¸º 1ï¼Œä¸‹é¢æ˜¯æŒ‰ç…§æ—¶é—´é¡ºåºæ‰§è¡Œä¸¤ä¸ªäº‹åŠ¡çš„è¡Œä¸ºã€‚

```mysql
create table T(c int) engine=InnoDB;
insert into T(c) values(1);
```

![img](https://static001.geekbang.org/resource/image/7d/f8/7dea45932a6b722eb069d2264d0066f8.png?wh=1142*1420)

æˆ‘ä»¬æ¥çœ‹çœ‹åœ¨ä¸åŒçš„éš”ç¦»çº§åˆ«ä¸‹ï¼Œäº‹åŠ¡ A ä¼šæœ‰å“ªäº›ä¸åŒçš„è¿”å›žç»“æžœï¼Œä¹Ÿå°±æ˜¯å›¾é‡Œé¢ V1ã€V2ã€V3 çš„è¿”å›žå€¼åˆ†åˆ«æ˜¯ä»€ä¹ˆã€‚

* è‹¥éš”ç¦»çº§åˆ«æ˜¯â€œè¯»æœªæäº¤â€ï¼Œ åˆ™ V1 çš„å€¼å°±æ˜¯ 2ã€‚è¿™æ—¶å€™äº‹åŠ¡ B è™½ç„¶è¿˜æ²¡æœ‰æäº¤ï¼Œä½†æ˜¯ç»“æžœå·²ç»è¢« A çœ‹åˆ°äº†ã€‚å› æ­¤ï¼ŒV2ã€V3 ä¹Ÿéƒ½æ˜¯ 2ã€‚
* è‹¥éš”ç¦»çº§åˆ«æ˜¯â€œè¯»æäº¤â€ï¼Œåˆ™ V1 æ˜¯ 1ï¼ŒV2 çš„å€¼æ˜¯ 2ã€‚äº‹åŠ¡ B çš„æ›´æ–°åœ¨æäº¤åŽæ‰èƒ½è¢« A çœ‹åˆ°ã€‚æ‰€ä»¥ï¼Œ V3 çš„å€¼ä¹Ÿæ˜¯ 2ã€‚
* è‹¥éš”ç¦»çº§åˆ«æ˜¯â€œå¯é‡å¤è¯»â€ï¼Œåˆ™ V1ã€V2 æ˜¯ 1ï¼ŒV3 æ˜¯ 2ã€‚ä¹‹æ‰€ä»¥ V2 è¿˜æ˜¯ 1ï¼Œéµå¾ªçš„å°±æ˜¯è¿™ä¸ªè¦æ±‚ï¼šäº‹åŠ¡åœ¨æ‰§è¡ŒæœŸé—´çœ‹åˆ°çš„æ•°æ®å‰åŽå¿…é¡»æ˜¯ä¸€è‡´çš„ã€‚
* éš”ç¦»çº§åˆ«æ˜¯â€œä¸²è¡ŒåŒ–â€ï¼Œåˆ™åœ¨äº‹åŠ¡ B æ‰§è¡Œâ€œå°† 1 æ”¹æˆ 2â€çš„æ—¶å€™ï¼Œä¼šè¢«é”ä½ã€‚ç›´åˆ°äº‹åŠ¡ A æäº¤åŽï¼Œäº‹åŠ¡ B æ‰å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚æ‰€ä»¥ä»Ž A çš„è§’åº¦çœ‹ï¼Œ V1ã€V2 å€¼æ˜¯ 1ï¼ŒV3 çš„å€¼æ˜¯ 2ã€‚

åœ¨å®žçŽ°ä¸Šï¼Œæ•°æ®åº“é‡Œé¢ä¼šåˆ›å»ºä¸€ä¸ªè§†å›¾ï¼Œè®¿é—®çš„æ—¶å€™ä»¥è§†å›¾çš„é€»è¾‘ç»“æžœä¸ºå‡†ã€‚åœ¨â€œå¯é‡å¤è¯»â€éš”ç¦»çº§åˆ«ä¸‹ï¼Œè¿™ä¸ªè§†å›¾æ˜¯åœ¨äº‹åŠ¡å¯åŠ¨æ—¶åˆ›å»ºçš„ï¼Œæ•´ä¸ªäº‹åŠ¡å­˜åœ¨æœŸé—´éƒ½ç”¨è¿™ä¸ªè§†å›¾ã€‚åœ¨â€œè¯»æäº¤â€éš”ç¦»çº§åˆ«ä¸‹ï¼Œè¿™ä¸ªè§†å›¾æ˜¯åœ¨æ¯ä¸ª SQL è¯­å¥å¼€å§‹æ‰§è¡Œçš„æ—¶å€™åˆ›å»ºçš„ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œâ€œè¯»æœªæäº¤â€éš”ç¦»çº§åˆ«ä¸‹ç›´æŽ¥è¿”å›žè®°å½•ä¸Šçš„æœ€æ–°å€¼ï¼Œæ²¡æœ‰è§†å›¾æ¦‚å¿µï¼›è€Œâ€œä¸²è¡ŒåŒ–â€éš”ç¦»çº§åˆ«ä¸‹ç›´æŽ¥ç”¨åŠ é”çš„æ–¹å¼æ¥é¿å…å¹¶è¡Œè®¿é—®ã€‚

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨ä¸åŒçš„éš”ç¦»çº§åˆ«ä¸‹ï¼Œæ•°æ®åº“è¡Œä¸ºæ˜¯æœ‰æ‰€ä¸åŒçš„ã€‚Oracle æ•°æ®åº“çš„é»˜è®¤éš”ç¦»çº§åˆ«å…¶å®žå°±æ˜¯â€œè¯»æäº¤â€ï¼Œå› æ­¤å¯¹äºŽä¸€äº›ä»Ž Oracle è¿ç§»åˆ° MySQL çš„åº”ç”¨ï¼Œä¸ºä¿è¯æ•°æ®åº“éš”ç¦»çº§åˆ«çš„ä¸€è‡´ï¼Œä½ ä¸€å®šè¦è®°å¾—å°† MySQL çš„éš”ç¦»çº§åˆ«è®¾ç½®ä¸ºâ€œè¯»æäº¤â€ã€‚

é…ç½®çš„æ–¹å¼æ˜¯ï¼Œå°†å¯åŠ¨å‚æ•° transaction-isolation çš„å€¼è®¾ç½®æˆ READ-COMMITTEDã€‚ä½ å¯ä»¥ç”¨ show variables æ¥æŸ¥çœ‹å½“å‰çš„å€¼ã€‚

```mysql

show variables like 'transaction_isolation';
```

```bash
+-----------------------+-----------------+
| Variable_name         | Value           |
+-----------------------+-----------------+
| transaction_isolation | REPEATABLE-READ |
+-----------------------+-----------------+
```

æ€»ç»“æ¥è¯´ï¼Œå­˜åœ¨å³åˆç†ï¼Œæ¯ç§éš”ç¦»çº§åˆ«éƒ½æœ‰è‡ªå·±çš„ä½¿ç”¨åœºæ™¯ï¼Œä½ è¦æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡æƒ…å†µæ¥å®šã€‚æˆ‘æƒ³ä½ å¯èƒ½ä¼šé—®é‚£ä»€ä¹ˆæ—¶å€™éœ€è¦â€œå¯é‡å¤è¯»â€çš„åœºæ™¯å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªæ•°æ®æ ¡å¯¹é€»è¾‘çš„æ¡ˆä¾‹ã€‚

å‡è®¾ä½ åœ¨ç®¡ç†ä¸€ä¸ªä¸ªäººé“¶è¡Œè´¦æˆ·è¡¨ã€‚ä¸€ä¸ªè¡¨å­˜äº†è´¦æˆ·ä½™é¢ï¼Œä¸€ä¸ªè¡¨å­˜äº†è´¦å•æ˜Žç»†ã€‚åˆ°äº†æœˆåº•ä½ è¦åšæ•°æ®æ ¡å¯¹ï¼Œä¹Ÿå°±æ˜¯åˆ¤æ–­ä¸Šä¸ªæœˆçš„ä½™é¢å’Œå½“å‰ä½™é¢çš„å·®é¢ï¼Œæ˜¯å¦ä¸Žæœ¬æœˆçš„è´¦å•æ˜Žç»†ä¸€è‡´ã€‚ä½ ä¸€å®šå¸Œæœ›åœ¨æ ¡å¯¹è¿‡ç¨‹ä¸­ï¼Œå³ä½¿æœ‰ç”¨æˆ·å‘ç”Ÿäº†ä¸€ç¬”æ–°çš„äº¤æ˜“ï¼Œä¹Ÿä¸å½±å“ä½ çš„æ ¡å¯¹ç»“æžœã€‚

è¿™æ—¶å€™ä½¿ç”¨â€œå¯é‡å¤è¯»â€éš”ç¦»çº§åˆ«å°±å¾ˆæ–¹ä¾¿ã€‚äº‹åŠ¡å¯åŠ¨æ—¶çš„è§†å›¾å¯ä»¥è®¤ä¸ºæ˜¯é™æ€çš„ï¼Œä¸å—å…¶ä»–äº‹åŠ¡æ›´æ–°çš„å½±å“ã€‚

## äº‹åŠ¡éš”ç¦»çš„å®žçŽ°

ç†è§£äº†äº‹åŠ¡çš„éš”ç¦»çº§åˆ«ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹äº‹åŠ¡éš”ç¦»å…·ä½“æ˜¯æ€Žä¹ˆå®žçŽ°çš„ã€‚è¿™é‡Œæˆ‘ä»¬å±•å¼€è¯´æ˜Žâ€œå¯é‡å¤è¯»â€ã€‚

åœ¨ MySQL ä¸­ï¼Œå®žé™…ä¸Šæ¯æ¡è®°å½•åœ¨æ›´æ–°çš„æ—¶å€™éƒ½ä¼šåŒæ—¶è®°å½•ä¸€æ¡å›žæ»šæ“ä½œã€‚è®°å½•ä¸Šçš„æœ€æ–°å€¼ï¼Œé€šè¿‡å›žæ»šæ“ä½œï¼Œéƒ½å¯ä»¥å¾—åˆ°å‰ä¸€ä¸ªçŠ¶æ€çš„å€¼ã€‚

å‡è®¾ä¸€ä¸ªå€¼ä»Ž 1 è¢«æŒ‰é¡ºåºæ”¹æˆäº† 2ã€3ã€4ï¼Œåœ¨å›žæ»šæ—¥å¿—é‡Œé¢å°±ä¼šæœ‰ç±»ä¼¼ä¸‹é¢çš„è®°å½•ã€‚

![img](https://static001.geekbang.org/resource/image/d9/ee/d9c313809e5ac148fc39feff532f0fee.png?wh=1142*737)

å½“å‰å€¼æ˜¯ 4ï¼Œä½†æ˜¯åœ¨æŸ¥è¯¢è¿™æ¡è®°å½•çš„æ—¶å€™ï¼Œä¸åŒæ—¶åˆ»å¯åŠ¨çš„äº‹åŠ¡ä¼šæœ‰ä¸åŒçš„ read-viewã€‚å¦‚å›¾ä¸­çœ‹åˆ°çš„ï¼Œåœ¨è§†å›¾ Aã€Bã€C é‡Œé¢ï¼Œè¿™ä¸€ä¸ªè®°å½•çš„å€¼åˆ†åˆ«æ˜¯ 1ã€2ã€4ï¼ŒåŒä¸€æ¡è®°å½•åœ¨ç³»ç»Ÿä¸­å¯ä»¥å­˜åœ¨å¤šä¸ªç‰ˆæœ¬ï¼Œå°±æ˜¯æ•°æ®åº“çš„å¤šç‰ˆæœ¬å¹¶å‘æŽ§åˆ¶ï¼ˆMVCCï¼‰ã€‚å¯¹äºŽ read-view Aï¼Œè¦å¾—åˆ° 1ï¼Œå°±å¿…é¡»å°†å½“å‰å€¼ä¾æ¬¡æ‰§è¡Œå›¾ä¸­æ‰€æœ‰çš„å›žæ»šæ“ä½œå¾—åˆ°ã€‚

åŒæ—¶ä½ ä¼šå‘çŽ°ï¼Œå³ä½¿çŽ°åœ¨æœ‰å¦å¤–ä¸€ä¸ªäº‹åŠ¡æ­£åœ¨å°† 4 æ”¹æˆ 5ï¼Œè¿™ä¸ªäº‹åŠ¡è·Ÿ read-view Aã€Bã€C å¯¹åº”çš„äº‹åŠ¡æ˜¯ä¸ä¼šå†²çªçš„ã€‚

ä½ ä¸€å®šä¼šé—®ï¼Œå›žæ»šæ—¥å¿—æ€»ä¸èƒ½ä¸€ç›´ä¿ç•™å§ï¼Œä»€ä¹ˆæ—¶å€™åˆ é™¤å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼Œåœ¨ä¸éœ€è¦çš„æ—¶å€™æ‰åˆ é™¤ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç³»ç»Ÿä¼šåˆ¤æ–­ï¼Œå½“æ²¡æœ‰äº‹åŠ¡å†éœ€è¦ç”¨åˆ°è¿™äº›å›žæ»šæ—¥å¿—æ—¶ï¼Œå›žæ»šæ—¥å¿—ä¼šè¢«åˆ é™¤ã€‚

ä»€ä¹ˆæ—¶å€™æ‰ä¸éœ€è¦äº†å‘¢ï¼Ÿå°±æ˜¯å½“ç³»ç»Ÿé‡Œæ²¡æœ‰æ¯”è¿™ä¸ªå›žæ»šæ—¥å¿—æ›´æ—©çš„ read-view çš„æ—¶å€™ã€‚

åŸºäºŽä¸Šé¢çš„è¯´æ˜Žï¼Œæˆ‘ä»¬æ¥è®¨è®ºä¸€ä¸‹ä¸ºä»€ä¹ˆå»ºè®®ä½ å°½é‡ä¸è¦ä½¿ç”¨é•¿äº‹åŠ¡ã€‚

é•¿äº‹åŠ¡æ„å‘³ç€ç³»ç»Ÿé‡Œé¢ä¼šå­˜åœ¨å¾ˆè€çš„äº‹åŠ¡è§†å›¾ã€‚ç”±äºŽè¿™äº›äº‹åŠ¡éšæ—¶å¯èƒ½è®¿é—®æ•°æ®åº“é‡Œé¢çš„ä»»ä½•æ•°æ®ï¼Œæ‰€ä»¥è¿™ä¸ªäº‹åŠ¡æäº¤ä¹‹å‰ï¼Œæ•°æ®åº“é‡Œé¢å®ƒå¯èƒ½ç”¨åˆ°çš„å›žæ»šè®°å½•éƒ½å¿…é¡»ä¿ç•™ï¼Œè¿™å°±ä¼šå¯¼è‡´å¤§é‡å ç”¨å­˜å‚¨ç©ºé—´ã€‚

åœ¨ MySQL 5.5 åŠä»¥å‰çš„ç‰ˆæœ¬ï¼Œå›žæ»šæ—¥å¿—æ˜¯è·Ÿæ•°æ®å­—å…¸ä¸€èµ·æ”¾åœ¨ ibdata æ–‡ä»¶é‡Œçš„ï¼Œå³ä½¿é•¿äº‹åŠ¡æœ€ç»ˆæäº¤ï¼Œå›žæ»šæ®µè¢«æ¸…ç†ï¼Œæ–‡ä»¶ä¹Ÿä¸ä¼šå˜å°ã€‚æˆ‘è§è¿‡æ•°æ®åªæœ‰ 20GBï¼Œè€Œå›žæ»šæ®µæœ‰ 200GB çš„åº“ã€‚æœ€ç»ˆåªå¥½ä¸ºäº†æ¸…ç†å›žæ»šæ®µï¼Œé‡å»ºæ•´ä¸ªåº“ã€‚

é™¤äº†å¯¹å›žæ»šæ®µçš„å½±å“ï¼Œé•¿äº‹åŠ¡è¿˜å ç”¨é”èµ„æºã€‚

## äº‹åŠ¡çš„å¯åŠ¨æ–¹å¼

å¦‚å‰é¢æ‰€è¿°ï¼Œé•¿äº‹åŠ¡æœ‰è¿™äº›æ½œåœ¨é£Žé™©ï¼Œæˆ‘å½“ç„¶æ˜¯å»ºè®®ä½ å°½é‡é¿å…ã€‚å…¶å®žå¾ˆå¤šæ—¶å€™ä¸šåŠ¡å¼€å‘åŒå­¦å¹¶ä¸æ˜¯æœ‰æ„ä½¿ç”¨é•¿äº‹åŠ¡ï¼Œé€šå¸¸æ˜¯ç”±äºŽè¯¯ç”¨æ‰€è‡´ã€‚MySQL çš„äº‹åŠ¡å¯åŠ¨æ–¹å¼æœ‰ä»¥ä¸‹å‡ ç§ï¼š

1. æ˜¾å¼å¯åŠ¨äº‹åŠ¡è¯­å¥ï¼Œ begin æˆ– start transactionã€‚é…å¥—çš„æäº¤è¯­å¥æ˜¯ commitï¼Œå›žæ»šè¯­å¥æ˜¯ rollbackã€‚
2. set autocommit=0ï¼Œè¿™ä¸ªå‘½ä»¤ä¼šå°†è¿™ä¸ªçº¿ç¨‹çš„è‡ªåŠ¨æäº¤å…³æŽ‰ã€‚æ„å‘³ç€å¦‚æžœä½ åªæ‰§è¡Œä¸€ä¸ª select è¯­å¥ï¼Œè¿™ä¸ªäº‹åŠ¡å°±å¯åŠ¨äº†ï¼Œè€Œä¸”å¹¶ä¸ä¼šè‡ªåŠ¨æäº¤ã€‚è¿™ä¸ªäº‹åŠ¡æŒç»­å­˜åœ¨ç›´åˆ°ä½ ä¸»åŠ¨æ‰§è¡Œ commit æˆ– rollback è¯­å¥ï¼Œæˆ–è€…æ–­å¼€è¿žæŽ¥ã€‚

æœ‰äº›å®¢æˆ·ç«¯è¿žæŽ¥æ¡†æž¶ä¼šé»˜è®¤è¿žæŽ¥æˆåŠŸåŽå…ˆæ‰§è¡Œä¸€ä¸ª set autocommit=0 çš„å‘½ä»¤ã€‚è¿™å°±å¯¼è‡´æŽ¥ä¸‹æ¥çš„æŸ¥è¯¢éƒ½åœ¨äº‹åŠ¡ä¸­ï¼Œå¦‚æžœæ˜¯é•¿è¿žæŽ¥ï¼Œå°±å¯¼è‡´äº†æ„å¤–çš„é•¿äº‹åŠ¡ã€‚

å› æ­¤ï¼Œæˆ‘ä¼šå»ºè®®ä½ æ€»æ˜¯ä½¿ç”¨ set autocommit=1, é€šè¿‡æ˜¾å¼è¯­å¥çš„æ–¹å¼æ¥å¯åŠ¨äº‹åŠ¡ã€‚

ä½†æ˜¯æœ‰çš„å¼€å‘åŒå­¦ä¼šçº ç»“â€œå¤šä¸€æ¬¡äº¤äº’â€çš„é—®é¢˜ã€‚å¯¹äºŽä¸€ä¸ªéœ€è¦é¢‘ç¹ä½¿ç”¨äº‹åŠ¡çš„ä¸šåŠ¡ï¼Œç¬¬äºŒç§æ–¹å¼æ¯ä¸ªäº‹åŠ¡åœ¨å¼€å§‹æ—¶éƒ½ä¸éœ€è¦ä¸»åŠ¨æ‰§è¡Œä¸€æ¬¡ â€œbeginâ€ï¼Œå‡å°‘äº†è¯­å¥çš„äº¤äº’æ¬¡æ•°ã€‚å¦‚æžœä½ ä¹Ÿæœ‰è¿™ä¸ªé¡¾è™‘ï¼Œæˆ‘å»ºè®®ä½ ä½¿ç”¨ commit work and chain è¯­æ³•ã€‚

åœ¨ autocommit ä¸º 1 çš„æƒ…å†µä¸‹ï¼Œç”¨ begin æ˜¾å¼å¯åŠ¨çš„äº‹åŠ¡ï¼Œå¦‚æžœæ‰§è¡Œ commit åˆ™æäº¤äº‹åŠ¡ã€‚å¦‚æžœæ‰§è¡Œ commit work and chainï¼Œåˆ™æ˜¯æäº¤äº‹åŠ¡å¹¶è‡ªåŠ¨å¯åŠ¨ä¸‹ä¸€ä¸ªäº‹åŠ¡ï¼Œè¿™æ ·ä¹ŸçœåŽ»äº†å†æ¬¡æ‰§è¡Œ begin è¯­å¥çš„å¼€é”€ã€‚åŒæ—¶å¸¦æ¥çš„å¥½å¤„æ˜¯ä»Žç¨‹åºå¼€å‘çš„è§’åº¦æ˜Žç¡®åœ°çŸ¥é“æ¯ä¸ªè¯­å¥æ˜¯å¦å¤„äºŽäº‹åŠ¡ä¸­ã€‚

ä½ å¯ä»¥åœ¨ information_schema åº“çš„ innodb_trx è¿™ä¸ªè¡¨ä¸­æŸ¥è¯¢é•¿äº‹åŠ¡ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªè¯­å¥ï¼Œç”¨äºŽæŸ¥æ‰¾æŒç»­æ—¶é—´è¶…è¿‡ 60s çš„äº‹åŠ¡ã€‚

```mysql
select * from information_schema.innodb_trx where TIME_TO_SEC(timediff(now(),trx_started))>60
```
